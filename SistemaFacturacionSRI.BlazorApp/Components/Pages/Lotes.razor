@page "/productos/lotes/{id:int}"
@using SistemaFacturacionSRI.Domain.DTOs.LotesProducto
@using SistemaFacturacionSRI.Domain.Entities
@inject HttpClient Http
@inject NavigationManager NavManager

<PageTitle>Detalle de Producto y Lotes</PageTitle>

<style>
    /* ------------------------------------------- */
    /* ESTILOS DE ESTRUCTURA Y FONDO (Consistente) */
    /* ------------------------------------------- */
    .container {
        max-width: 1100px;
        margin: 60px auto;
        padding: 48px;
        border-radius: 24px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.7);
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 28px;
    }

    .header h1 {
        font-weight: 800;
        font-size: 32px;
        color: #1a1a1a;
    }

    /* ------------------------------------------- */
    /* BOTONES */
    /* ------------------------------------------- */
    .btn-base {
        border-radius: 12px;
        padding: 10px 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-primary {
        /* Azul Degradado (Guardar Lote) */
        background: linear-gradient(135deg, #0058ff, #4f9eff);
        color: white;
        border: none;
        box-shadow: 0 2px 6px rgba(0, 85, 255, 0.25);
    }

    .btn-secondary {
        /* Gris claro (Volver/Cancelar) */
        background: #f1f5f9;
        color: #111827;
        border: 1px solid #e2e8f0;
        box-shadow: none;
    }
    
    .btn-save-price {
        /* Verde (Guardar Precio) */
        background: linear-gradient(135deg, #10b981, #34d399);
        color: white;
        border: none;
        box-shadow: 0 2px 6px rgba(16, 185, 129, 0.25);
        margin-left: 10px;
        font-size: 0.9em;
    }

    /* ------------------------------------------- */
    /* FORMULARIOS Y ALERTAS (Consistente) */
    /* ------------------------------------------- */
    label {
        font-weight: 600;
        color: #333;
        margin-bottom: 6px;
        display: block;
    }
    
    .form-control, .form-select {
        width: 100%;
        padding: 12px 16px;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        transition: border-color 0.2s ease;
    }
    .form-control:focus, .form-select:focus {
        border-color: #0058ff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 85, 255, 0.1);
    }

    .alert {
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-weight: 600;
        border: 1px solid transparent;
    }
    .alert-info { background-color: #e0f2fe; color: #0c4a6e; border-color: #bae6fd; }
    .alert-danger { background-color: #fee2e2; color: #991b1b; border-color: #fca5a5; }
    .alert-success { background-color: #d1fae5; color: #065f46; border-color: #6ee7b7; }
    .alert-warning { background-color: #fef3c7; color: #92400e; border-color: #fcd34d; }


    /* ------------------------------------------- */
    /* RESUMEN DE PRODUCTO (Card) */
    /* ------------------------------------------- */
    .product-summary-card {
        background-color: #ffffff;
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e7eb;
    }
    
    .product-info strong {
        color: #1f2937;
    }
    
    .product-info span {
        color: #4b5563;
        display: block;
        margin-bottom: 5px;
    }

    .price-update-group {
        display: flex;
        align-items: flex-end;
        gap: 10px;
        margin-bottom: 15px;
        text-align: right;
        justify-content: flex-end;
    }

    .price-update-group .form-control {
        width: 120px;
        padding: 8px 12px;
        font-weight: 700;
        font-size: 1.1em;
    }
    
    .total-stock {
        font-size: 1.2em;
        font-weight: 700;
        margin-top: 20px;
        text-align: right;
    }
    
    .badge-base {
        padding: 6px 12px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 0.9em;
    }
    .badge-iva-0 { background-color: #d1fae5; color: #065f46; } /* Stock > 0 */
    .badge-stock-danger { background-color: #fecaca; color: #b91c1c; } /* Stock = 0 */
    
    
    /* ------------------------------------------- */
    /* TABLA DE LOTES */
    /* ------------------------------------------- */
    .table-responsive {
        max-height: 400px;
        overflow-y: auto;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e7eb;
    }

    .styled-table {
        width: 100%;
        border-collapse: collapse;
        background: #ffffff;
    }

    .styled-table thead th {
        background-color: #f9fafb;
        color: #333;
        font-weight: 700;
        text-align: left;
        padding: 15px 16px;
        border-bottom: 2px solid #e5e7eb;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .styled-table tbody tr {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .styled-table tbody tr:nth-child(even) {
        background-color: #fcfdfe; /* Franjas suaves */
    }

    .styled-table tbody tr:hover {
        background-color: #e6f0ff; /* Fondo azul suave al pasar el ratón */
    }

    .styled-table tbody td {
        padding: 14px 16px;
        color: #4b5563;
        font-size: 15px;
        border-bottom: 1px solid #f3f4f6;
    }
    
    /* ------------------------------------------- */
    /* MODAL (Consistente) */
    /* ------------------------------------------- */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-box {
        background: white;
        border-radius: 18px;
        padding: 36px;
        width: 90%;
        max-width: 550px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
    }
    
    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 24px;
    }
</style>

<div class="container">
    <div class="header">
        <h1>📦 Detalle de Inventario: @productoActual?.Descripcion</h1>
        <button class="btn-secondary btn-base" @onclick="GoBack">← Volver a Productos</button>
    </div>

    @if (isLoading)
    {
        <div class="alert alert-info">Cargando datos...</div>
    }
    else if (productoActual == null)
    {
        <div class="alert alert-danger">Producto no encontrado.</div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(requestMessage))
        {
            <div class="alert @requestClase">@requestMessage</div>
        }

        <!-- BLOQUE DE RESUMEN DE PRODUCTO Y PRECIO (Card) -->
        <div class="product-summary-card mb-4">
            <div class="row">
                <!-- Información del Producto -->
                <div class="col-md-6 product-info">
                    <strong>Código Principal:</strong> <span class="text-muted">@productoActual.CodigoPrincipal</span> <br />
                    <strong>IVA:</strong> <span class="text-muted">@productoActual.TarifaIva</span> <br />
                    @if (productoActual.EsPerecible)
                    {
                        <strong>Tipo:</strong> <span class="badge badge-warning text-dark badge-base">⏳ Perecible</span>
                    }
                    else
                    {
                        <strong>Tipo:</strong> <span class="badge badge-secondary badge-base">No Perecible</span>
                    }
                </div>

                <!-- Control de Precio y Stock -->
                <div class="col-md-6 d-flex flex-column align-items-end">
                    
                    <div class="price-update-group">
                        <div>
                            <label style="font-weight: 500;">PVP (Precio Unitario)</label>
                            <InputNumber TValue="decimal"
                                         @bind-Value="productoActual.PrecioUnitario"
                                         class="form-control text-end"
                                         style="width: 140px; display: inline-block;" />
                        </div>
                        <button class="btn-base btn-save-price" @onclick="GuardarPrecio">
                            💾 Guardar Precio
                        </button>
                    </div>

                    <h5 class="total-stock">
                        Stock Total:
                        <span class="badge-base @(productoActual.Stock > 0 ? "badge-iva-0" : "badge-stock-danger")">
                            @productoActual.Stock
                        </span>
                    </h5>
                </div>
            </div>
        </div>

        <h5 class="mt-4">📦 Lotes de Stock</h5>

        <div class="mb-3 d-flex justify-content-between align-items-center">
            <p class="text-muted">Haga clic en un lote para ver su historial de ajustes y modificar su stock.</p>
            <button class="btn-primary btn-base" @onclick="OpenLoteModal">+ Agregar Stock (Lote)</button>
        </div>

        @if (lotes == null || !lotes.Any())
        {
            <div class="alert alert-warning">No hay lotes registrados.</div>
        }
        else
        {
            <!-- TABLA DE LOTES ESTILIZADA -->
            <div class="table-responsive">
                <table class="styled-table">
                    <thead>
                        <tr>
                            <th># Lote</th>
                            <th>Cant. Actual</th>
                            <th>P. Compra Unitario</th>
                            <th>Costo Total</th>
                            <th>Fecha Ingreso</th>
                            @if (productoActual.EsPerecible)
                            {
                                <th>Caducidad</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var lote in lotes)
                        {
                            @* --- NAVEGACIÓN A PANTALLA DE AJUSTE (DetalleLote.razor) --- *@
                            <tr @onclick="@(() => NavManager.NavigateTo($"/productos/lotes/detalle/{lote.Id}"))">
                                <td>@lote.Id</td>
                                <td>@lote.CantidadActual</td>
                                <td>$@lote.PrecioCompraUnitario.ToString("0.00000")</td>
                                <td>$@lote.CostoTotalLote.ToString("0.00")</td>
                                <td>@lote.FechaRegistro.ToShortDateString()</td>
                                @if (productoActual.EsPerecible)
                                {
                                    <td style="@(lote.FechaCaducidad < DateTime.Today.AddMonths(1) ? "color: #dc2626; font-weight: 600;" : "color: #065f46;")">
                                        @(lote.FechaCaducidad?.ToShortDateString() ?? "N/A")
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    }
</div>

@if (showLoteModal)
{
    <div class="modal-overlay">
        <div class="modal-box">

            <h3 class="mb-4">+ Registrar Nuevo Lote</h3>

            <EditForm Model="@newLoteDto" OnValidSubmit="HandleLoteSubmit">
                <DataAnnotationsValidator />

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label>Cantidad *</label>
                        <InputNumber @bind-Value="newLoteDto.Cantidad" class="form-control text-end" @oninput="UpdateCostos" />
                        <ValidationMessage For="@(() => newLoteDto.Cantidad)" />
                    </div>

                    <div class="col-md-8 mb-3">
                        <label>Costo Total Lote *</label>
                        <InputNumber TValue="decimal" @bind-Value="costoTotalLote" class="form-control text-end" @oninput="UpdateCostos" />
                        <ValidationMessage For="@(() => newLoteDto.CostoTotalLote)" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Precio Compra Unitario (Calculado)</label>
                        <input disabled class="form-control"
                               value="@(newLoteDto.PrecioCompraUnitario?.ToString("0.00000") ?? "0.00000")" />
                        <ValidationMessage For="@(() => newLoteDto.PrecioCompraUnitario)" />
                    </div>

                    @if (productoActual?.EsPerecible == true)
                    {
                        <div class="col-md-6 mb-3">
                            <label>Fecha de Caducidad *</label>
                            <InputDate @bind-Value="newLoteDto.FechaCaducidad" class="form-control" />
                            <ValidationMessage For="@(() => newLoteDto.FechaCaducidad)" />
                        </div>
                    }
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary btn-base" @onclick="CloseLoteModal">Cancelar</button>
                    <button type="submit" class="btn-primary btn-base" disabled="@isSubmittingLote">
                        @(isSubmittingLote ? "Guardando..." : "Guardar Lote")
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}

@if (showWarningPrecio)
{
    <div class="modal-overlay">
        <div class="modal-box">

            <h3 class="mb-3" style="color:#f97316;">⚠ Advertencia de Precio</h3>

            <div class="alert alert-warning">
                @warningMessage
            </div>
            <p>¿Desea continuar y registrar el lote de todas formas?</p>

            <div class="modal-actions">
                <button class="btn-secondary btn-base" @onclick="() => showWarningPrecio = false">
                    Cancelar
                </button>

                <button class="btn-base btn-primary" style="background: linear-gradient(135deg, #dc2626, #ef4444);" @onclick="ConfirmarGuardadoConAdvertencia">
                    Sí, Registrar Lote
                </button>
            </div>

        </div>
    </div>
}


@code {
    [Parameter] public int Id { get; set; }

    private bool showWarningPrecio = false;
    private string warningMessage = "";
    private CreateLoteProducto lotePendienteConfirmacion;


    private Producto? productoActual;
    private List<LoteProducto>? lotes;
    private bool isLoading = true;

    // Modal
    private bool showLoteModal = false;
    private CreateLoteProducto newLoteDto = new();
    private decimal costoTotalLote = 0;
    private bool isSubmittingLote = false;

    // Mensajes
    private string requestMessage = "";
    private string requestClase = "alert-info";


    private async Task ConfirmarGuardadoConAdvertencia()
    {
        showWarningPrecio = false;
        await GuardarLote(lotePendienteConfirmacion);
    }


    protected override async Task OnParametersSetAsync()
    {
        await LoadData();
    }

    private async Task GuardarPrecio()
    {
        try
        {
            var dto = new { PrecioUnitario = productoActual!.PrecioUnitario };

            var response = await Http.PatchAsJsonAsync($"api/productos/{Id}/precio", dto);

            if (response.IsSuccessStatusCode)
            {
                MostrarMensaje("Precio actualizado correctamente.", "alert-success");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                MostrarMensaje("Error: " + error, "alert-danger");
            }
        }
        catch (Exception ex)
        {
            MostrarMensaje("Error al actualizar precio: " + ex.Message, "alert-danger");
        }
    }


    private async Task LoadData()
    {
        isLoading = true;

        try
        {
            productoActual = await Http.GetFromJsonAsync<Producto>($"api/productos/{Id}");
            lotes = await Http.GetFromJsonAsync<List<LoteProducto>>($"api/lotes/producto/{Id}");
        }
        catch (Exception ex)
        {
            MostrarMensaje($"Error al cargar datos: {ex.Message}", "alert-danger");
        }

        isLoading = false;
    }

    private void GoBack() => NavManager.NavigateTo("/productos");

    private void MostrarMensaje(string msg, string clase)
    {
        requestMessage = msg;
        requestClase = clase;
        StateHasChanged();
    }

    // --- MODAL LOGIC (Agregar Lote) ---

    private void OpenLoteModal()
    {
        newLoteDto = new CreateLoteProducto
        {
            ProductoId = Id,
            Cantidad = 1,
            CostoTotalLote = 0.01m,
            PrecioCompraUnitario = 0.00001m
        };

        costoTotalLote = 0.01m;
        showLoteModal = true;
        requestMessage = "";
    }

    private void CloseLoteModal()
    {
        showLoteModal = false;
    }

    private void UpdateCostos()
    {
        if (newLoteDto.Cantidad > 0 && costoTotalLote > 0)
        {
            newLoteDto.PrecioCompraUnitario =
                Math.Round(costoTotalLote / newLoteDto.Cantidad, 5);
        }
        else
        {
            newLoteDto.PrecioCompraUnitario = 0.00001m;
        }

        newLoteDto.CostoTotalLote = costoTotalLote;
    }


    private async Task HandleLoteSubmit()
    {
        UpdateCostos();

        if (productoActual?.EsPerecible == true && newLoteDto.FechaCaducidad == null)
        {
            MostrarMensaje("⚠ Debe ingresar la fecha de caducidad.", "alert-danger");
            return;
        }

        // --- CA-006: Advertencia si compra > venta ---
        if (newLoteDto.PrecioCompraUnitario > productoActual!.PrecioUnitario)
        {
            showWarningPrecio = true;
            warningMessage = $"⚠ El precio unitario de compra ({newLoteDto.PrecioCompraUnitario:C}) es MAYOR que el precio de venta actual ({productoActual.PrecioUnitario:C}). Esto podría generar pérdida.";
            lotePendienteConfirmacion = newLoteDto;  // guardamos la info temporal
            return;  // NO guardar todavía
        }

        await GuardarLote(newLoteDto);
    }


    private async Task GuardarLote(CreateLoteProducto dto)
    {
        isSubmittingLote = true;

        try
        {
            var response = await Http.PostAsJsonAsync("api/lotes", dto);

            if (response.IsSuccessStatusCode)
            {
                MostrarMensaje("✅ Lote registrado correctamente.", "alert-success");
                CloseLoteModal();
                await LoadData();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                MostrarMensaje($"❌ Error: {error}", "alert-danger");
            }
        }
        catch (Exception ex)
        {
            MostrarMensaje($"Error al registrar lote: {ex.Message}", "alert-danger");
        }
        finally
        {
            isSubmittingLote = false;
        }
    }


}