@page "/perfil"
@using SistemaFacturacionSRI.Domain.DTOs.Usuarios
@using SistemaFacturacionSRI.Domain.Entities
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using Blazored.LocalStorage
@using System.Net.Http.Headers

@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavManager
@inject ILocalStorageService LocalStorage

<PageTitle>Mi Perfil</PageTitle>

<style>
    /* ------------------------------------------- */
    /* ESTILOS BASE Y ESTRUCTURA */
    /* ------------------------------------------- */
    .container {
        max-width: 600px;
        margin: 60px auto;
        padding: 0;
    }

    .header {
        margin-bottom: 25px;
    }

        .header h1 {
            font-weight: 800;
            font-size: 32px;
            color: #1a1a1a;
        }

    /* Tarjeta de Formulario */
    .profile-card {
        background: #ffffff;
        border-radius: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e7eb;
        padding: 36px;
        width: 100%;
    }

    /* ------------------------------------------- */
    /* FORMULARIOS Y LABELS */
    /* ------------------------------------------- */
    label {
        font-weight: 600;
        color: #333;
        margin-bottom: 6px;
        display: block;
    }

    .form-control {
        padding: 12px 16px;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        transition: border-color 0.2s ease;
        width: 100%;
    }

        .form-control:focus {
            border-color: #0058ff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 85, 255, 0.1);
        }

    .mb-3 {
        margin-bottom: 1.5rem !important;
    }

    /* Campo deshabilitado */
    .disabled-input {
        background-color: #f3f4f6 !important;
        color: #4b5563;
        font-style: italic;
    }

    /* ------------------------------------------- */
    /* BOTÓN PRINCIPAL */
    /* ------------------------------------------- */
    .btn-primary {
        background: linear-gradient(135deg, #0058ff, #4f9eff);
        color: white;
        border: none;
        border-radius: 12px;
        padding: 12px 24px;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 85, 255, 0.25);
        transition: all 0.2s ease;
    }

        .btn-primary:hover {
            opacity: 0.9;
        }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 25px;
    }

    /* Mensajes */
    .alert-success {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #6ee7b7;
        padding: 15px;
        border-radius: 10px;
        font-weight: 600;
    }
</style>

<div class="container">
    <div class="header">
        <h1>👤 Mi Perfil</h1>
    </div>

    <div class="profile-card">
        @if (isLoading)
        {
            <div class="alert alert-info" style="text-align: center;">Cargando datos del perfil...</div>
        }
        else
        {
            <EditForm Model="@miPerfil" OnValidSubmit="ActualizarPerfil">
                <DataAnnotationsValidator />

                <div class="mb-3">
                    <label>Rol</label>
                    <input type="text" class="form-control disabled-input" value="@rolActual" disabled />
                    <small class="text-muted">Este campo no puede ser modificado.</small>
                </div>

                <div class="mb-3">
                    <label>Nombre de Usuario</label>
                    <InputText @bind-Value="miPerfil.NombreUsuario" class="form-control" />
                </div>

                <div class="mb-3">
                    <label>Nueva Contraseña</label>
                    <InputText @bind-Value="miPerfil.Password" type="password" class="form-control" placeholder="Dejar en blanco para no cambiar" />
                </div>

                <div class="modal-actions">
                    <button type="submit" class="btn-primary">Actualizar Mis Datos</button>
                </div>
            </EditForm>

            @if (mensajeExito)
            {
                <div class="alert alert-success mt-3">✅ Datos actualizados correctamente.</div>
            }
        }
    </div>
</div>

@code {
    private UpdateUsuario miPerfil = new();
    private string rolActual = "";
    private bool isLoading = true;
    private bool mensajeExito = false;

   
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        // Debug: Verifica en la consola del navegador (F12) si entra aquí
        Console.WriteLine($"Autenticado: {user.Identity?.IsAuthenticated}");

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            // RECUPERAR EL TOKEN Y ADJUNTARLO
            var token = await LocalStorage.GetItemAsStringAsync("authToken");
            if (!string.IsNullOrEmpty(token))
            {
                Http.DefaultRequestHeaders.Authorization =
                    new AuthenticationHeaderValue("Bearer", token.Replace("\"", ""));
            }

            // INTENTO ROBUSTO DE OBTENER EL ID
            // Buscamos por el tipo estándar O por "nameid" O por "sub"
            var idClaim = user.FindFirst(ClaimTypes.NameIdentifier)
                          ?? user.FindFirst("nameid")
                          ?? user.FindFirst("sub");

            var idString = idClaim?.Value;

            // Para el Rol
            var roleClaim = user.FindFirst(ClaimTypes.Role) ?? user.FindFirst("role");
            rolActual = roleClaim?.Value ?? "N/A";

            Console.WriteLine($"ID Encontrado en Token: {idString}"); // Debug

            if (int.TryParse(idString, out int userId))
            {
                try
                {
                    var usuarioDb = await Http.GetFromJsonAsync<Usuario>($"api/usuarios/{userId}");
                    if (usuarioDb != null)
                    {
                        miPerfil = new UpdateUsuario
                        {
                            Id = usuarioDb.Id,
                            NombreUsuario = usuarioDb.NombreUsuario,
                            Rol = usuarioDb.Rol,
                            Estado = usuarioDb.Estado,
                            Password = ""
                        };
                        Console.WriteLine("Perfil cargado con éxito.");
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error al cargar perfil desde API: {ex.Message}");
                }
            }
            else
            {
                Console.WriteLine("No se pudo convertir el ID del usuario a número.");
            }
        }
        isLoading = false;
    }

    private async Task ActualizarPerfil()
    {
        mensajeExito = false;

        try
        {
            // 2. RECUPERAR EL TOKEN (Para el PUT)
            // Es vital volver a asignarlo aquí por si el HttpClient perdió la cabecera
            var token = await LocalStorage.GetItemAsStringAsync("authToken");
            if (!string.IsNullOrEmpty(token))
            {
                Http.DefaultRequestHeaders.Authorization =
                    new AuthenticationHeaderValue("Bearer", token.Replace("\"", ""));
            }

            var response = await Http.PutAsJsonAsync($"api/usuarios/{miPerfil.Id}", miPerfil);

            if (response.IsSuccessStatusCode)
            {
                mensajeExito = true;
                miPerfil.Password = ""; // Limpiar campo contraseña
            }
            else
            {
                var errorBody = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error al actualizar: {errorBody}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error de comunicación al actualizar: {ex.Message}");
        }
    }
}