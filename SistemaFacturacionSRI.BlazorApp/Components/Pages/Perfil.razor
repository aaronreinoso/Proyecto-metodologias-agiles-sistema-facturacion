@page "/perfil"
@using SistemaFacturacionSRI.Domain.DTOs.Usuarios
@using SistemaFacturacionSRI.Domain.Entities
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavManager

<PageTitle>Mi Perfil</PageTitle>

<style>
    /* ------------------------------------------- */
    /* ESTILOS BASE Y ESTRUCTURA (Consistente) */
    /* ------------------------------------------- */
    .container {
        max-width: 600px;
        margin: 60px auto;
        padding: 0;
    }

    .header {
        margin-bottom: 25px;
    }

        .header h1 {
            font-weight: 800;
            font-size: 32px;
            color: #1a1a1a;
        }

    /* Tarjeta de Formulario */
    .profile-card {
        background: #ffffff;
        border-radius: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e7eb;
        padding: 36px;
        width: 100%;
    }

    /* ------------------------------------------- */
    /* FORMULARIOS Y LABELS */
    /* ------------------------------------------- */
    label {
        font-weight: 600;
        color: #333;
        margin-bottom: 6px;
        display: block;
    }

    .form-control {
        padding: 12px 16px;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        transition: border-color 0.2s ease;
        width: 100%;
    }

        .form-control:focus {
            border-color: #0058ff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 85, 255, 0.1);
        }

    .mb-3 {
        margin-bottom: 1.5rem !important;
    }

    /* Campo deshabilitado */
    .disabled-input {
        background-color: #f3f4f6 !important;
        color: #4b5563;
        font-style: italic;
    }

    /* ------------------------------------------- */
    /* BOTÓN PRINCIPAL */
    /* ------------------------------------------- */
    .btn-primary {
        background: linear-gradient(135deg, #0058ff, #4f9eff);
        color: white;
        border: none;
        border-radius: 12px;
        padding: 12px 24px;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 85, 255, 0.25);
        transition: all 0.2s ease;
    }

        .btn-primary:hover {
            opacity: 0.9;
        }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 25px;
    }

    /* Mensajes */
    .alert-success {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #6ee7b7;
        padding: 15px;
        border-radius: 10px;
        font-weight: 600;
    }

</style>

<div class="container">
    <div class="header">
        <h1>👤 Mi Perfil</h1>
    </div>

    <div class="profile-card">
        @if (isLoading)
        {
            <div class="alert alert-info" style="text-align: center;">Cargando datos del perfil...</div>
        }
        else
        {
            <EditForm Model="@miPerfil" OnValidSubmit="ActualizarPerfil">
                <DataAnnotationsValidator />

                <div class="mb-3">
                    <label>Rol</label>
                    <input type="text" class="form-control disabled-input" value="@rolActual" disabled />
                    <small class="text-muted">Este campo no puede ser modificado.</small>
                </div>

                <div class="mb-3">
                    <label>Nombre de Usuario</label>
                    <InputText @bind-Value="miPerfil.NombreUsuario" class="form-control" />
                </div>

                <div class="mb-3">
                    <label>Nueva Contraseña</label>
                    <InputText @bind-Value="miPerfil.Password" type="password" class="form-control" placeholder="Dejar en blanco para no cambiar" />
                </div>

                <div class="modal-actions">
                    <button type="submit" class="btn-primary">Actualizar Mis Datos</button>
                </div>
            </EditForm>

            @if (mensajeExito)
            {
                <div class="alert alert-success mt-3">✅ Datos actualizados correctamente.</div>
            }
        }
    </div>
</div>

@code {
    private UpdateUsuario miPerfil = new();
    private string rolActual = "";
    private bool isLoading = true;
    private bool mensajeExito = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            var idString = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            rolActual = user.FindFirst(ClaimTypes.Role)?.Value ?? "N/A";

            if (int.TryParse(idString, out int userId))
            {
                try
                {
                    var usuarioDb = await Http.GetFromJsonAsync<Usuario>($"api/usuarios/{userId}");
                    if (usuarioDb != null)
                    {
                        miPerfil = new UpdateUsuario
                        {
                            Id = usuarioDb.Id,
                            NombreUsuario = usuarioDb.NombreUsuario,
                            Rol = usuarioDb.Rol,
                            Estado = usuarioDb.Estado,
                            Password = "" // Limpio por seguridad
                        };
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error al cargar perfil: {ex.Message}");
                    // Opcional: Mostrar un mensaje de error en la UI si la carga falla
                }
            }
        }
        isLoading = false;
    }

    private async Task ActualizarPerfil()
    {
        // Limpiar mensaje de éxito al inicio de la operación
        mensajeExito = false;

        try
        {
            var response = await Http.PutAsJsonAsync($"api/usuarios/{miPerfil.Id}", miPerfil);

            if (response.IsSuccessStatusCode)
            {
                mensajeExito = true;
                // Importante: Limpiamos el campo de contraseña después de la actualización, ya que no queremos que quede cargado.
                miPerfil.Password = "";
                // En un sistema real, si el nombre de usuario o rol cambia, se requeriría re-autenticar al usuario.
            }
            else
            {
                // Manejar errores de la API si la actualización falla
                var errorBody = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error al actualizar: {errorBody}");
                // Nota: Podrías añadir una variable para mostrar errores específicos de la API en la UI si lo deseas.
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error de comunicación al actualizar: {ex.Message}");
        }
    }
}