@page "/productos/crear"
@using SistemaFacturacionSRI.Domain.DTOs.Productos
@using SistemaFacturacionSRI.Domain.Entities
@using SistemaFacturacionSRI.Domain.Reglas
@inject HttpClient Http
@inject NavigationManager NavManager

<PageTitle>Nuevo Producto - Wizard</PageTitle>

<style>
    /* Estilos CSS simplificados para la explicación */
    .container {
        max-width: 900px;
        margin: 60px auto;
        padding: 48px;
        border-radius: 24px;
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.06);
    }

    .header h1 {
        font-weight: 800;
        font-size: 32px;
    }

    .btn-secondary {
        background: #f1f5f9;
        border-radius: 10px;
        color: #111827;
        border: 1px solid #e2e8f0;
        padding: 9px 16px;
        font-weight: 600;
        cursor: pointer;
    }

    .card-category {
        border: 1px solid #e2e8f0;
        padding: 20px;
        border-radius: 12px;
        cursor: pointer;
    }

        .card-category.selected {
            border-width: 2px;
            border-color: #0058ff;
            background-color: #e6f0ff;
        }

    .validation-message {
        color: #ef4444;
        font-size: 12px;
        display: block;
    }
</style>

<div class="container">
    <div class="header d-flex justify-content-between align-items-center">
        <h1>➕ Registrar Nuevo Producto</h1>
        <button class="btn-secondary" @onclick="GoBack">
            ← Volver a Productos
        </button>
    </div>

    @if (isLoading)
    {
        <div class="alert alert-info">Cargando tarifas...</div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(requestMessage))
        {
            <div class="alert @requestClase">@requestMessage</div>
        }

        <EditForm Model="@productoDto" OnValidSubmit="GuardarProducto">
            <DataAnnotationsValidator />

            <h5 class="mt-3">1. Seleccione la Categoría Fiscal (Wizard)</h5>
            <div class="row g-3">
                @foreach (var categoria in ReglasProducto.CategoriasBase)
                {
                    <div class="col-md-4" @onclick="() => SelectCategoria(categoria)">
                        <div class="card-category @(selectedCategoriaId == categoria.Id ? "selected" : "")">
                            <h6 class="mb-1">@categoria.Nombre</h6>
                            <small class="text-muted">IVA @(tarifasIva?.FirstOrDefault(t => t.Id == categoria.TarifaIvaIdPorDefecto)?.Porcentaje.ToString("0") ?? "--")%</small>
                        </div>
                    </div>
                }
            </div>
            @if (selectedCategoriaId == 0)
            {
                <div class="validation-message">Debe seleccionar una categoría de base.</div>
            }

            <h5 class="mt-4">🏷️ Identidad del Producto</h5>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label>Nombre Genérico (*)</label>
                    <InputText @bind-Value="productoDto.NombreGenerico" class="form-control" @oninput="() => CheckUnicidad()" />
                    <ValidationMessage For="@(() => productoDto.NombreGenerico)" />
                </div>
                <div class="col-md-4 mb-3">
                    <label>Marca (*)</label>
                    <InputText @bind-Value="productoDto.Marca" class="form-control" @oninput="() => CheckUnicidad()" />
                    <ValidationMessage For="@(() => productoDto.Marca)" />
                </div>
                <div class="col-md-4 mb-3">
                    <label>Presentación (*)</label>
                    <InputText @bind-Value="productoDto.Presentacion" class="form-control" @oninput="() => CheckUnicidad()" />
                    <ValidationMessage For="@(() => productoDto.Presentacion)" />
                </div>
            </div>

            @if (unicidadError)
            {
                <div class="alert alert-danger my-3">
                    ❌ Error: Ya existe un producto con esa combinación.
                </div>
            }

            <h5 class="mt-4">📊 Clasificación y Precios</h5>

            <div class="row">
               

                <div class="col-md-4 mb-3">
                    <label>Tarifa IVA (*)</label>
                    <InputSelect @bind-Value="productoDto.TarifaIvaId" class="form-select" disabled="@(!PermiteCambioIVA)">
                        <option value="0">-- Seleccione --</option>
                        @if (tarifasIva != null)
                        {
                            @foreach (var t in tarifasIva.Where(t => t.Porcentaje == 0 || t.Porcentaje == 15))
                            {
                                <option value="@t.Id">@t.Porcentaje.ToString("0")% (Código: @t.CodigoSRI)</option>
                            }
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => productoDto.TarifaIvaId)" />
                </div>

                <div class="col-md-4 mb-3">
                    <label>Es Perecible (Caduca)</label>
                    <InputCheckbox @bind-Value="productoDto.EsPerecible" class="form-check-input" />
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label>Precio Unitario (PVP)</label>
                    <InputNumber TValue="decimal" @bind-Value="productoDto.PrecioUnitario" class="form-control" />
                    <small class="text-muted">Si deja en 0, no podrá facturar hasta tener stock.</small>
                </div>

                <div class="col-md-6 mb-3">
                    <label>Código Principal</label>
                    <InputText @bind-Value="productoDto.CodigoPrincipal" class="form-control" />
                    <small class="text-muted">Dejar en blanco para autogenerar.</small>
                </div>
            </div>

            <div class="text-end border-top pt-3 mt-3">
                <button type="submit" class="btn btn-success btn-lg" disabled="@(isSubmitting || unicidadError || selectedCategoriaId == 0)">
                    Guardar Producto
                </button>
            </div>
        </EditForm>
    }
</div>

@code {
    [Parameter] public int Id { get; set; } = 0;
    private CreateProducto productoDto = new() { TipoProducto = "Bien" };
    private List<TarifaIva>? tarifasIva;
    private bool isLoading = true;
    private bool isSubmitting = false;
    private bool unicidadError = false;
    private int selectedCategoriaId = 0;
    private bool PermiteCambioIVA = true;
    private string requestMessage = string.Empty;
    private string requestClase = "alert-info";

    protected override async Task OnInitializedAsync()
    {
        await LoadTarifas();
    }

    private async Task LoadTarifas()
    {
        isLoading = true;
        try
        {
            tarifasIva = await Http.GetFromJsonAsync<List<TarifaIva>>("api/tarifasiva");

            // Inicializar el IVA con la opción por defecto (15%)
            productoDto.TarifaIvaId = ReglasProducto.IVA_15_ID;
            productoDto.EsPerecible = false;
            selectedCategoriaId = ReglasProducto.CategoriasBase.First(c => c.TarifaIvaIdPorDefecto == ReglasProducto.IVA_15_ID).Id;
        }
        catch (Exception ex)
        {
            MostrarMensaje($"Error al cargar datos iniciales: {ex.Message}", "alert-danger");
        }
        isLoading = false;
    }

    private void SelectCategoria(ReglasProducto.CategoriaSimulada categoria)
    {
        selectedCategoriaId = categoria.Id;

        // 1. Configuraciones Automáticas
        productoDto.TarifaIvaId = categoria.TarifaIvaIdPorDefecto;
        productoDto.EsPerecible = categoria.EsPereciblePorDefecto;

        // 2. Banderas de control
        PermiteCambioIVA = categoria.PermiteCambioIVA;

        // Re-chequeamos unicidad
        CheckUnicidad();
        StateHasChanged();
    }

    private void GoBack() => NavManager.NavigateTo("/productos");

    private async Task CheckUnicidad()
    {
        // ... (Implementación de unicidad simplificada, ya que no estamos en edición) ...
        if (string.IsNullOrWhiteSpace(productoDto.NombreGenerico) ||
      string.IsNullOrWhiteSpace(productoDto.Marca) ||
      string.IsNullOrWhiteSpace(productoDto.Presentacion))
        {
            unicidadError = false;
            return;
        }

        try
        {
            var url = $"api/productos/check-unicidad?nombre={productoDto.NombreGenerico}&marca={productoDto.Marca}&presentacion={productoDto.Presentacion}&excludedId=0";
            var existe = await Http.GetFromJsonAsync<bool>(url);
            unicidadError = existe;
        }
        catch (Exception ex)
        {
            MostrarMensaje($"Error de validación: {ex.Message}", "alert-warning");
        }
    }

    private async Task GuardarProducto()
    {
        if (unicidadError || selectedCategoriaId == 0) return;

        isSubmitting = true;
        requestMessage = string.Empty;

        try
        {
            HttpResponseMessage response;
            Producto? productoGuardado = null;

            // Mapeo final a CreateProducto para el POST
            var submitDto = new CreateProducto
            {
                CodigoPrincipal = productoDto.CodigoPrincipal ?? string.Empty,
                NombreGenerico = productoDto.NombreGenerico,
                Marca = productoDto.Marca,
                Presentacion = productoDto.Presentacion,
                TarifaIvaId = productoDto.TarifaIvaId,
                EsPerecible = productoDto.EsPerecible,
                TipoProducto = productoDto.TipoProducto,
                PrecioUnitario = productoDto.PrecioUnitario,
                CodigoAuxiliar = productoDto.CodigoAuxiliar,
                CodigoICE = productoDto.CodigoICE,
                PorcentajeICE = productoDto.PorcentajeICE,
                CodigoIRBPNR = productoDto.CodigoIRBPNR,
                PorcentajeIRBPNR = productoDto.PorcentajeIRBPNR,
            };

            response = await Http.PostAsJsonAsync("api/productos", submitDto);

            if (response.IsSuccessStatusCode)
            {
                productoGuardado = await response.Content.ReadFromJsonAsync<Producto>();
                MostrarMensaje("✅ Producto guardado. Continuar a registro de lotes.", "alert-success");
                // Redirigir al detalle de lotes del producto recién creado
                NavManager.NavigateTo($"/productos/lotes/{productoGuardado!.Id}");
            }
            else
            {
                var errorBody = await response.Content.ReadAsStringAsync();
                MostrarMensaje($"❌ Error: {ExtraerMensajeError(errorBody)}", "alert-danger");
            }
        }
        catch (Exception ex)
        {
            MostrarMensaje($"Error en la solicitud: {ex.Message}", "alert-danger");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private string ExtraerMensajeError(string jsonResponse)
    {
        // ... (Lógica de extracción de error) ...
        try
        {
            if (!jsonResponse.Trim().StartsWith("{"))
                return jsonResponse.Trim('"');

            using var doc = System.Text.Json.JsonDocument.Parse(jsonResponse);
            var root = doc.RootElement;

            if (root.TryGetProperty("errors", out var errors))
            {
                foreach (var prop in errors.EnumerateObject())
                {
                    if (prop.Value.ValueKind == System.Text.Json.JsonValueKind.Array)
                    {
                        return prop.Value[0].GetString() ?? "Datos inválidos.";
                    }
                }
            }
            if (root.TryGetProperty("message", out var message))
            {
                return message.GetString() ?? "Error en la solicitud.";
            }

            return "Verifique los datos ingresados.";
        }
        catch
        {
            return jsonResponse;
        }
    }

    private void MostrarMensaje(string texto, string clase)
    {
        requestMessage = texto;
        requestClase = clase;
        StateHasChanged();
    }
}