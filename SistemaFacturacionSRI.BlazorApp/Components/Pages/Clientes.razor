@page "/clientes"
@using SistemaFacturacionSRI.Domain.DTOs.Clientes
@using SistemaFacturacionSRI.Domain.Entities
@inject HttpClient Http


<PageTitle>Gestión de Clientes</PageTitle>

<div class="p-4 bg-white shadow-xl rounded-lg">
    <div class="flex justify-between items-center mb-6 border-b pb-3">
        <h1 class="text-3xl font-extrabold text-blue-800">Clientes</h1>
        <!-- Botón para abrir el modal de nuevo cliente -->
        <button @onclick="() => OpenForm(0)"
                class="px-5 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150 flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            Nuevo Cliente
        </button>
    </div>

    <!-- Mensaje de Carga/Error -->
    @if (clientes == null)
    {
        <p class="text-center py-10 text-gray-500">
            <span class="animate-pulse">Cargando clientes...</span>
        </p>
    }
    else if (errorMessage != null)
    {
        <p class="text-center py-10 text-red-600 font-bold">Error al cargar: @errorMessage</p>
    }
    else if (clientes.Count == 0)
    {
        <p class="text-center py-10 text-gray-500 italic">No hay clientes registrados.</p>
    }
    else
    {
        <!-- Tabla de Clientes (Responsive) -->
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white rounded-lg overflow-hidden border border-gray-200">
                <thead class="bg-blue-600 text-white">
                    <tr>
                        <th class="py-3 px-4 text-left">ID</th>
                        <th class="py-3 px-4 text-left">Identificación</th>
                        <th class="py-3 px-4 text-left">Nombre Completo</th>
                        <th class="py-3 px-4 text-left hidden sm:table-cell">Email</th>
                        <th class="py-3 px-4 text-left hidden md:table-cell">Teléfono</th>
                        <th class="py-3 px-4 text-left">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var cliente in clientes)
                    {
                        <tr class="border-t hover:bg-blue-50 transition duration-150">
                            <td class="py-3 px-4">@cliente.Id</td>
                            <td class="py-3 px-4 font-medium">@cliente.Identificacion</td>
                            <td class="py-3 px-4">@cliente.NombreCompleto</td>
                            <td class="py-3 px-4 hidden sm:table-cell text-sm text-gray-600">@cliente.Email</td>
                            <td class="py-3 px-4 hidden md:table-cell text-sm text-gray-600">@cliente.Telefono</td>
                            <td class="py-3 px-4 space-x-2">
                                <!-- Botón Editar -->
                                <button @onclick="() => OpenForm(cliente.Id)"
                                        class="text-blue-500 hover:text-blue-700 transition duration-150"
                                        title="Editar">
                                    <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7-5a2 2 0 012-2h5a2 2 0 012 2v5a2 2 0 01-2 2h-5a2 2 0 01-2-2zM15 3l4 4L9 19H5v-4L15 3z"></path></svg>
                                </button>
                                <!-- Botón Eliminar -->
                                <button @onclick="() => ConfirmDelete(cliente.Id, cliente.NombreCompleto)"
                                        class="text-red-500 hover:text-red-700 transition duration-150"
                                        title="Eliminar">
                                    <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>


<!-- Modal de Formulario (Crear/Editar) -->
@if (showFormModal)
{
    <div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-2xl font-bold text-blue-800">@(currentCliente.Id == 0 ? "Registrar Nuevo Cliente" : $"Editar Cliente: {currentCliente.Id}")</h3>
                <button @onclick="CloseForm" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <EditForm Model="@currentCliente" OnValidSubmit="HandleSubmit" class="p-6">
                <DataAnnotationsValidator />

                @if (!string.IsNullOrEmpty(formMessage))
                {
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4" role="alert">
                        @formMessage
                    </div>
                }

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Identificación (Cédula/RUC):</label>
                        <InputText @bind-Value="currentCliente.Identificacion" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        <ValidationMessage For="@(() => currentCliente.Identificacion)" />
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Nombre Completo:</label>
                        <InputText @bind-Value="currentCliente.NombreCompleto" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        <ValidationMessage For="@(() => currentCliente.NombreCompleto)" />
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Dirección:</label>
                    <InputText @bind-Value="currentCliente.Direccion" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    <ValidationMessage For="@(() => currentCliente.Direccion)" />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Teléfono:</label>
                        <InputText @bind-Value="currentCliente.Telefono" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        <ValidationMessage For="@(() => currentCliente.Telefono)" />
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                        <InputText @bind-Value="currentCliente.Email" type="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        <ValidationMessage For="@(() => currentCliente.Email)" />
                    </div>
                </div>

                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" @onclick="CloseForm"
                            class="bg-gray-400 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-500 transition duration-150">
                        Cancelar
                    </button>
                    <button type="submit" disabled="@isSubmitting"
                            class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-150 disabled:opacity-50">
                        @if (isSubmitting)
                        {
                            <span class="flex items-center">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Procesando...
                            </span>
                        }
                        else
                        {
                            <span>@(currentCliente.Id == 0 ? "Guardar" : "Actualizar")</span>
                        }
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}

<!-- Modal de Confirmación de Eliminación -->
@if (showDeleteModal)
{
    <div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-xl font-bold text-red-600 mb-4">Confirmar Eliminación</h3>
            <p class="text-gray-700 mb-6">¿Estás seguro de que quieres eliminar al cliente **@clienteToDeleteName** con ID **@clienteToDeleteId**?</p>
            <div class="flex justify-end space-x-3">
                <button @onclick="CancelDelete"
                        class="bg-gray-400 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-500 transition duration-150">
                    Cancelar
                </button>
                <button @onclick="HandleDelete" disabled="@isSubmitting"
                        class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-150 disabled:opacity-50">
                    Eliminar
                </button>
            </div>
        </div>
    </div>
}

@code {
    private List<Cliente>? clientes;
    private string? errorMessage;
    private bool showFormModal = false;
    private UpdateCliente currentCliente = new UpdateCliente(); // Usamos Update DTO para edición y lo inicializamos vacío para creación
    private bool isSubmitting = false;
    private string formMessage = string.Empty;

    // Variables para el modal de eliminación
    private bool showDeleteModal = false;
    private int clienteToDeleteId;
    private string clienteToDeleteName = string.Empty;

    // Se ejecuta al iniciar el componente
    protected override async Task OnInitializedAsync()
    {
        await LoadClientes();
    }

    private async Task LoadClientes()
    {
        clientes = null;
        errorMessage = null;
        try
        {
            // Llama al endpoint GET /api/clientes
            clientes = await Http.GetFromJsonAsync<List<Cliente>>("api/clientes");
        }
        catch (HttpRequestException ex)
        {
            // Manejo de errores de HTTP (API no disponible, error 500, etc.)
            errorMessage = $"Error de conexión con la API: {ex.Message}";
            Console.WriteLine(errorMessage);
        }
        catch (Exception ex)
        {
            errorMessage = $"Ocurrió un error inesperado: {ex.Message}";
            Console.WriteLine(errorMessage);
        }
    }

    // Abre el modal de formulario
    private async Task OpenForm(int id)
    {
        formMessage = string.Empty;
        if (id == 0)
        {
            // Nuevo Cliente
            currentCliente = new UpdateCliente { Id = 0 };
        }
        else
        {
            // Editar Cliente
            try
            {
                var clienteToEdit = await Http.GetFromJsonAsync<Cliente>($"api/clientes/{id}");
                if (clienteToEdit != null)
                {
                    // Mapear ClienteDto a UpdateClienteDto
                    currentCliente = new UpdateCliente
                    {
                        Id = clienteToEdit.Id,
                        Identificacion = clienteToEdit.Identificacion,
                        NombreCompleto = clienteToEdit.NombreCompleto,
                        Direccion = clienteToEdit.Direccion,
                        Telefono = clienteToEdit.Telefono,
                        Email = clienteToEdit.Email
                    };
                }
            }
            catch (Exception ex)
            {
                formMessage = $"Error al cargar datos del cliente: {ex.Message}";
                return;
            }
        }
        showFormModal = true;
    }

    // Cierra el modal de formulario
    private void CloseForm()
    {
        showFormModal = false;
        currentCliente = new UpdateCliente();
    }

    // Maneja la creación o actualización al enviar el formulario
    private async Task HandleSubmit()
    {
        isSubmitting = true;
        formMessage = string.Empty;

        try
        {
            HttpResponseMessage response;

            if (currentCliente.Id == 0)
            {
                // CREATE (Mapeamos a CreateClienteDto para el POST)
                var createDto = new CreateCliente
                {
                    Identificacion = currentCliente.Identificacion,
                    NombreCompleto = currentCliente.NombreCompleto,
                    Direccion = currentCliente.Direccion,
                    Telefono = currentCliente.Telefono,
                    Email = currentCliente.Email
                };
                response = await Http.PostAsJsonAsync("api/clientes", createDto);
            }
            else
            {
                // UPDATE (PUT)
                response = await Http.PutAsJsonAsync($"api/clientes/{currentCliente.Id}", currentCliente);
            }

            if (response.IsSuccessStatusCode)
            {
                CloseForm();
                await LoadClientes(); // Recarga la lista de clientes
            }
            else
            {
                // Manejar errores de la API (ej. validaciones)
                var errorContent = await response.Content.ReadAsStringAsync();
                formMessage = $"Error: {response.ReasonPhrase}. Detalles: {errorContent}";
                Console.WriteLine($"API Error: {errorContent}");
            }
        }
        catch (Exception ex)
        {
            formMessage = $"Ocurrió un error en la solicitud: {ex.Message}";
            Console.WriteLine($"Request Error: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    // Abre el modal de confirmación de eliminación
    private void ConfirmDelete(int id, string name)
    {
        clienteToDeleteId = id;
        clienteToDeleteName = name;
        showDeleteModal = true;
    }

    // Cancela la eliminación
    private void CancelDelete()
    {
        showDeleteModal = false;
        clienteToDeleteId = 0;
        clienteToDeleteName = string.Empty;
    }

    // Maneja la eliminación
    private async Task HandleDelete()
    {
        isSubmitting = true;
        try
        {
            // Llama al endpoint DELETE /api/clientes/{id}
            var response = await Http.DeleteAsync($"api/clientes/{clienteToDeleteId}");

            if (response.IsSuccessStatusCode)
            {
                await LoadClientes(); // Recarga la lista
            }
            else
            {
                // Muestra el error en la consola
                Console.WriteLine($"Error al eliminar: {response.ReasonPhrase}");
                errorMessage = "Error al intentar eliminar el cliente.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error de solicitud al eliminar: {ex.Message}");
            errorMessage = "Error de conexión al eliminar.";
        }
        finally
        {
            isSubmitting = false;
            showDeleteModal = false;
        }
    }
}
