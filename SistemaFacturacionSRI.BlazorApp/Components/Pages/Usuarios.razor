@page "/usuarios"
@using SistemaFacturacionSRI.Domain.DTOs.Usuarios
@using SistemaFacturacionSRI.Domain.Entities
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Gestión de Empleados</PageTitle>

<style>
    /* ------------------------------------------- */
    /* ESTILOS DE ESTRUCTURA Y FONDO (Consistente) */
    /* ------------------------------------------- */
    .container {
        max-width: 1100px;
        margin: 60px auto;
        padding: 48px;
        border-radius: 24px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.7);
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 28px;
    }

        .header h1 {
            font-weight: 800;
            font-size: 32px;
            color: #1a1a1a;
        }

    /* ------------------------------------------- */
    /* BOTONES */
    /* ------------------------------------------- */
    .btn-base {
        border-radius: 12px;
        padding: 10px 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
    }

    .btn-primary {
        /* Azul Degradado (Guardar) */
        background: linear-gradient(135deg, #0058ff, #4f9eff);
        color: white;
        box-shadow: 0 2px 6px rgba(0, 85, 255, 0.25);
    }

    .btn-secondary {
        /* Gris claro (Volver/Cancelar) */
        background: #f1f5f9;
        color: #111827;
        border: 1px solid #e2e8f0;
        box-shadow: none;
    }

    .icon-btn {
        border: none;
        background: none;
        font-size: 18px;
        opacity: 0.7;
        transition: opacity 0.2s ease, transform 0.15s ease;
        cursor: pointer;
    }

        .icon-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

    .actions {
        display: flex;
        gap: 8px;
        justify-content: center;
    }

    /* ------------------------------------------- */
    /* TABLA ESTILIZADA (Consistente con lotes.razor) */
    /* ------------------------------------------- */
    .table-container {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e7eb;
    }

    .styled-table {
        width: 100%;
        border-collapse: collapse;
        background: #ffffff;
    }

        .styled-table thead th {
            background-color: #f9fafb;
            color: #333;
            font-weight: 700;
            text-align: left;
            padding: 15px 16px;
            border-bottom: 2px solid #e5e7eb;
        }

        .styled-table tbody tr {
            transition: background-color 0.2s ease;
        }

            .styled-table tbody tr:nth-child(even) {
                background-color: #fcfdfe;
            }

            .styled-table tbody tr:hover {
                background-color: #e6f0ff;
            }

        .styled-table tbody td {
            padding: 14px 16px;
            color: #4b5563;
            font-size: 15px;
            border-bottom: 1px solid #f3f4f6;
        }

    /* FILA INACTIVA */
    .row-inactive {
        opacity: 0.6;
        font-style: italic;
        background-color: #f0f0f0 !important;
    }

        .row-inactive:hover {
            background-color: #e9e9e9 !important;
        }

    /* ------------------------------------------- */
    /* BADGES (Estado) */
    /* ------------------------------------------- */
    .badge-status {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        font-size: 13px;
        font-weight: 600;
        border-radius: 8px;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 6px;
    }

    .status-active {
        background-color: #d1fae5;
        color: #065f46;
    }

    .status-inactive {
        background-color: #fecaca;
        color: #b91c1c;
    }

    /* ------------------------------------------- */
    /* MODAL DE EDICIÓN/CREACIÓN */
    /* ------------------------------------------- */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-box {
        background: white;
        border-radius: 18px;
        padding: 36px;
        width: 90%;
        max-width: 480px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        text-align: left;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

        .modal-header h3 {
            font-weight: 700;
            font-size: 1.5rem;
            margin: 0;
        }

    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
    }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 24px;
    }

    .form-control {
        margin-bottom: 15px;
    }

</style>

<AuthorizeView Roles="Administrador">
    <Authorized>
        <div class="container">
            <div class="header">
                <h1>👥 Gestión de Empleados</h1>
                <button class="btn-primary btn-base" @onclick="() => OpenForm(0)">＋ Nuevo Vendedor</button>
            </div>

            @if (usuarios == null)
            {
                <div class="alert alert-info">Cargando...</div>
            }
            else
            {
                <div class="table-container">
                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Rol</th>
                                <th>Estado</th>
                                <th style="text-align: center;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var u in usuarios)
                            {
                                <tr class="@(u.Estado ? "" : "row-inactive")">
                                    <td>@u.NombreUsuario</td>
                                    <td>@u.Rol</td>
                                    <td>
                                        @if (u.Estado)
                                        {
                                            <span class="badge-status status-active">
                                                <span class="status-dot" style="background-color: #10b981;"></span>
                                                Activo
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge-status status-inactive">
                                                <span class="status-dot" style="background-color: #b91c1c;"></span>
                                                Inactivo
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <div class="actions">
                                            <button class="icon-btn" title="Editar" @onclick="() => OpenForm(u.Id)">
                                                <span style="color: #0058ff;">✏️</span>
                                            </button>

                                            @if (u.Estado)
                                            {
                                                <button class="icon-btn" style="color:red" title="Desactivar" @onclick="() => ToggleEstado(u.Id)">
                                                    🚫
                                                </button>
                                            }
                                            else
                                            {
                                                <button class="icon-btn" style="color:green" title="Activar" @onclick="() => ToggleEstado(u.Id)">
                                                    ✅
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="alert alert-danger container">Acceso restringido. Solo administradores.</div>
    </NotAuthorized>
</AuthorizeView>

@if (showModal)
{
    <div class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>@(currentUser.Id == 0 ? "Nuevo Vendedor" : $"Editar: {currentUser.NombreUsuario}")</h3>
                <button class="close-btn" @onclick="CloseForm">×</button>
            </div>

            <EditForm Model="@currentUser" OnValidSubmit="HandleSubmit">
                <label>Nombre de Usuario</label>
                <InputText @bind-Value="currentUser.NombreUsuario" class="form-control" />

                <label>Contraseña @(currentUser.Id != 0 ? "(Dejar vacío para no cambiar)" : "")</label>
                <InputText @bind-Value="currentUser.Password" type="password" class="form-control" />

                <hr style="border-color:#e2e8f0; margin: 20px 0;">

                <div class="modal-actions">
                    <button type="button" class="btn-secondary btn-base" @onclick="CloseForm">Cancelar</button>
                    <button type="submit" class="btn-primary btn-base">Guardar</button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    private List<Usuario>? usuarios;
    private bool showModal = false;
    private UpdateUsuario currentUser = new();
    private int currentUserId; // ID del admin logueado

    protected override async Task OnInitializedAsync()
    {
        // 1. Obtener ID del usuario logueado para filtrarlo
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            // Extraer el ID del Claim que configuramos en el paso anterior
            var idClaim = user.FindFirst(ClaimTypes.NameIdentifier);
            if (idClaim != null) int.TryParse(idClaim.Value, out currentUserId);
        }

        await LoadUsuarios();
    }

    private async Task LoadUsuarios()
    {
        try
        {
            var listaCompleta = await Http.GetFromJsonAsync<List<Usuario>>("api/usuarios");

            // 2. FILTRO: Excluir al administrador actual de la lista
            if (listaCompleta != null)
            {
                usuarios = listaCompleta.Where(u => u.Id != currentUserId).ToList();
            }
        }
        catch (Exception)
        {
            // Manejo de error de carga simple
            usuarios = new List<Usuario>();
        }
    }

    private async Task OpenForm(int id)
    {
        if (id == 0)
        {
            // Por defecto creamos EMPLEADOS activos
            currentUser = new UpdateUsuario { Rol = "Empleado", Estado = true };
        }
        else
        {
            var user = await Http.GetFromJsonAsync<Usuario>($"api/usuarios/{id}");
            currentUser = new UpdateUsuario
            {
                Id = user!.Id,
                NombreUsuario = user.NombreUsuario,
                Rol = user.Rol,
                Estado = user.Estado,
                Password = ""
            };
        }
        showModal = true;
    }

    private void CloseForm() => showModal = false;

    private async Task HandleSubmit()
    {
        // El Blazor framework maneja el estado de envío (isSubmitting) automáticamente en EditForm
        // No necesitamos un estado `isSubmitting` manual aquí si solo queremos bloquear el botón.

        try
        {
            if (currentUser.Id == 0)
            {
                var createDto = new CreateUsuario
                {
                    NombreUsuario = currentUser.NombreUsuario,
                    Password = currentUser.Password ?? "1234",
                    Rol = "Empleado" // SIEMPRE SE CREAN COMO EMPLEADOS
                };
                await Http.PostAsJsonAsync("api/usuarios", createDto);
            }
            else
            {
                await Http.PutAsJsonAsync($"api/usuarios/{currentUser.Id}", currentUser);
            }

            CloseForm();
            await LoadUsuarios();
        }
        catch (Exception)
        {
            // Implementar manejo de errores con mensaje al usuario si es necesario
        }
    }

    private async Task ToggleEstado(int id)
    {
        try
        {
            await Http.PatchAsync($"api/usuarios/{id}/toggle-estado", null);
            await LoadUsuarios();
        }
        catch (Exception)
        {
            // Implementar manejo de errores
        }
    }
}