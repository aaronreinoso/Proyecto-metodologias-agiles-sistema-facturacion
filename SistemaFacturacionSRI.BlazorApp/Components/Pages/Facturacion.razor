@page "/facturacion"
@using SistemaFacturacionSRI.Domain.Entities
@using SistemaFacturacionSRI.Domain.DTOs.Facturas
@using SistemaFacturacionSRI.Domain.DTOs.Clientes
@using SistemaFacturacionSRI.Domain.Enumss
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>Punto de Venta</PageTitle>

<style>
    /* --- ESTILOS GENERALES --- */
    body {
        background-color: #f3f4f6;
        font-family: 'Inter', sans-serif;
    }

    .container-fluid {
        max-width: 1600px;
        margin: 20px auto;
        padding: 0 20px;
    }
    /* Más ancho para aprovechar el espacio */

    /* --- TARJETAS --- */
    .sales-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .sales-card-header {
        background: #f8fafc;
        padding: 12px 20px;
        border-bottom: 1px solid #e5e7eb;
        font-weight: 700;
        color: #334155;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .sales-card-body {
        padding: 15px;
        flex-grow: 1;
    }

    /* --- AUTOCOMPLETADO Y INPUTS --- */
    .autocomplete-wrapper {
        position: relative;
    }

    .form-control-custom {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        transition: border-color 0.2s;
    }

        .form-control-custom:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }

    .autocomplete-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 100;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        max-height: 300px;
        overflow-y: auto;
        margin-top: 4px;
    }

    .autocomplete-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f1f5f9;
    }

        .autocomplete-item:hover {
            background-color: #f1f5f9;
        }

    /* --- PRODUCTOS (Scroll horizontal si son muchos resultados o vertical limitado) --- */
    .product-results-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
        max-height: 250px;
        overflow-y: auto;
        padding: 5px;
    }

    .product-card-mini {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 10px;
        cursor: pointer;
        transition: transform 0.1s, border-color 0.1s;
        background: white;
    }

        .product-card-mini:hover {
            transform: translateY(-2px);
            border-color: #2563eb;
        }

    .stock-tag {
        font-size: 0.7rem;
        padding: 2px 6px;
        background: #dcfce7;
        color: #166534;
        border-radius: 4px;
        display: inline-block;
    }

        .stock-tag.low {
            background: #fee2e2;
            color: #991b1b;
        }

    /* --- CARRITO (DISEÑO HORIZONTAL) --- */
    .cart-table {
        width: 100%;
        border-collapse: collapse;
    }

        .cart-table th {
            text-align: left;
            padding: 10px;
            background: #f8fafc;
            color: #64748b;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .cart-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }

        .cart-table tr:last-child td {
            border-bottom: none;
        }

    .qty-group {
        display: flex;
        align-items: center;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        width: fit-content;
    }

    .btn-qty {
        background: #f1f5f9;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        font-weight: bold;
    }

        .btn-qty:hover {
            background: #e2e8f0;
        }

    .qty-val {
        padding: 0 10px;
        font-weight: 600;
        min-width: 30px;
        text-align: center;
    }

    /* --- FOOTER DE TOTALES (BARRA INFERIOR) --- */
    .cart-totals-bar {
        background: #1e293b;
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
    }

    .total-group {
        display: flex;
        gap: 30px;
        align-items: center;
    }

    .total-item span {
        display: block;
        font-size: 0.8rem;
        color: #94a3b8;
        text-transform: uppercase;
    }

    .total-item strong {
        font-size: 1.2rem;
    }

    .grand-total strong {
        font-size: 2rem;
        color: #4ade80;
    }

    .btn-checkout {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 1.1rem;
        cursor: pointer;
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.4);
    }

        .btn-checkout:disabled {
            background: #64748b;
            cursor: not-allowed;
            box-shadow: none;
        }

    /* --- DATOS CLIENTE --- */
    .client-badge {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        padding: 8px 12px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
    }

    /* Modal reutilizado */
    .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(4px);
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: white;
        width: 90%;
        max-width: 600px;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
    }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div><h3 class="fw-bold mb-0">Punto de Venta</h3></div>
        <div>
            @if (!string.IsNullOrEmpty(mensajeExito))
            {
                <span class="badge bg-success p-2">@mensajeExito</span>
            }
            @if (!string.IsNullOrEmpty(mensajeError))
            {
                <span class="badge bg-danger p-2">@mensajeError</span>
            }
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(facturaErrorMessage))
    {
        <div class="alert alert-warning mb-3"><strong>⚠ Alerta:</strong> @facturaErrorMessage</div>
    }

    <div class="row g-3 mb-3">

        <div class="col-lg-4">
            <div class="sales-card">
                <div class="sales-card-header">
                    <span>👤 Cliente</span>
                    <button class="btn btn-sm btn-primary ms-auto" @onclick="OpenClienteModal">Nuevo</button>
                </div>
                <div class="sales-card-body">
                    <div class="autocomplete-wrapper">
                        <input type="text" class="form-control-custom" placeholder="Buscar cliente (Nombre/RUC)..."
                               @bind="terminoBusquedaCliente" @bind:event="oninput"
                               @onfocus="() => mostrarListaClientes = true"
                               @onblur="OcultarListaClientes" />

                        @if (mostrarListaClientes && clientesFiltrados.Any())
                        {
                            <div class="autocomplete-list">
                                @foreach (var c in clientesFiltrados)
                                {
                                    <div class="autocomplete-item" @onmousedown="() => SeleccionarCliente(c)">
                                        <div class="fw-bold">@c.NombreCompleto</div>
                                        <small class="text-muted">@c.Identificacion</small>
                                    </div>
                                }
                            </div>
                        }
                    </div>

                    @if (clienteActual != null)
                    {
                        <div class="client-badge">
                            <div>
                                <div class="fw-bold text-primary">@clienteActual.NombreCompleto</div>
                                <div class="small text-muted">@clienteActual.TipoIdentificacion: @clienteActual.Identificacion</div>
                                <div class="small text-muted">@clienteActual.Email</div>
                            </div>
                            <button class="btn btn-sm btn-close" @onclick="LimpiarCliente"></button>
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted mt-4 p-3 border border-dashed rounded bg-light">
                            Seleccione un cliente para facturar
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="sales-card">
                <div class="sales-card-header">📦 Catálogo</div>
                <div class="sales-card-body d-flex flex-column">
                    <input type="text" class="form-control-custom mb-2" placeholder="🔍 Buscar producto por código o nombre..."
                           @bind="terminoBusquedaProd" @bind:event="oninput" />

                    <div class="product-results-container flex-grow-1">
                        @if (productosFiltrados.Any())
                        {
                            @foreach (var prod in productosFiltrados)
                            {
                                <div class="product-card-mini" @onclick="() => AgregarAlCarrito(prod)">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="stock-tag @(prod.Stock < 5 ? "low" : "")">Stock: @prod.Stock</span>
                                        <span class="fw-bold text-primary">$@prod.PrecioUnitario.ToString("F2")</span>
                                    </div>
                                    <div class="fw-bold small text-truncate" title="@prod.Descripcion">@prod.Descripcion</div>
                                    <div class="small text-muted">@prod.CodigoPrincipal</div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="col-12 text-center text-muted py-4">No se encontraron productos.</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="sales-card">
                <div class="sales-card-header bg-dark text-white">
                    🛒 Detalle de Factura
                    <span class="ms-auto badge bg-light text-dark">@carrito.Count Items</span>
                </div>
                <div class="sales-card-body p-0">
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="cart-table">
                            <thead>
                                <tr>
                                    <th style="width: 40%;">Producto</th>
                                    <th style="width: 15%;">Precio Unit.</th>
                                    <th style="width: 10%;">IVA</th>
                                    <th style="width: 15%;">Cantidad</th>
                                    <th style="width: 15%; text-align: right;">Subtotal</th>
                                    <th style="width: 5%;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (carrito.Count == 0)
                                {
                                    <tr>
                                        <td colspan="6" class="text-center py-5 text-muted">
                                            <h4>El carrito está vacío</h4>
                                            <p>Busque productos arriba para agregarlos</p>
                                        </td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var item in carrito)
                                    {
                                        <tr>
                                            <td>
                                                <span class="fw-bold d-block">@item.ProductoNombre</span>
                                                <small class="text-muted">Cod: @item.ProductoId</small>
                                            </td>
                                            <td>$@item.PrecioUnitario.ToString("F2")</td>
                                            <td><span class="badge bg-light text-dark border">@item.PorcentajeIVA.ToString("0")%</span></td>
                                            <td>
                                                <div class="qty-group">
                                                    <button class="btn-qty" @onclick="() => AjustarCantidad(item, -1)">-</button>
                                                    <div class="qty-val">@item.Cantidad</div>
                                                    <button class="btn-qty" @onclick="() => AjustarCantidad(item, 1)">+</button>
                                                </div>
                                            </td>
                                            <td class="text-end fw-bold">$@item.Subtotal.ToString("F2")</td>
                                            <td class="text-center">
                                                <button class="btn btn-sm text-danger" @onclick="() => RemoverDelCarrito(item)">🗑</button>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="cart-totals-bar">
                        <div class="total-group">
                            <div class="total-item">
                                <span>Subtotal 15%</span>
                                <strong>$@CalcularSubtotalIVA15().ToString("F2")</strong>
                            </div>
                            <div class="total-item">
                                <span>Subtotal 0%</span>
                                <strong>$@CalcularSubtotalIVA0().ToString("F2")</strong>
                            </div>
                            <div class="total-item">
                                <span>Total IVA</span>
                                <strong>$@CalcularIVA().ToString("F2")</strong>
                            </div>
                        </div>

                        <div class="d-flex align-items-center gap-4">
                            <div class="total-item grand-total text-end">
                                <span>Total a Pagar</span>
                                <strong>$@((carrito.Sum(x => x.Subtotal) + CalcularIVA()).ToString("F2"))</strong>
                            </div>
                            <button class="btn-checkout"
                                    disabled="@(clienteActual == null || carrito.Count == 0 || isSubmitting)"
                                    @onclick="GenerarFactura">
                                @(isSubmitting ? "Procesando..." : "✅ FACTURAR")
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* --- MODAL CLIENTE (REUTILIZADO) --- *@
@if (showClienteModal)
{
    <div class="modal-backdrop">
        <div class="modal-content">
            <div class="d-flex justify-content-between mb-3">
                <h3 class="m-0">Nuevo Cliente</h3>
                <button class="btn-close" @onclick="CloseClienteModal"></button>
            </div>

            @if (!string.IsNullOrEmpty(clienteValidationError))
            {
                <div class="alert alert-danger">@clienteValidationError</div>
            }

            <EditForm Model="@newClienteDto" OnValidSubmit="HandleNewClientSubmit">
                <DataAnnotationsValidator />
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label class="form-label small fw-bold">Tipo ID</label>
                        <InputSelect @bind-Value="newClienteDto.TipoIdentificacion" class="form-select" @onchange="OnTipoIdentificacionChange">
                            @foreach (var t in Enum.GetValues(typeof(TipoIdentificacion)))
                            {
                                <option value="@t">@t</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-6">
                        <label class="form-label small fw-bold">Número</label>
                        <InputText @bind-Value="newClienteDto.Identificacion" class="form-control"
                                   maxlength="@GetMaxLength(newClienteDto.TipoIdentificacion)"
                                   onkeypress="@(newClienteDto.TipoIdentificacion == TipoIdentificacion.Pasaporte ? "" : "return event.charCode >= 48 && event.charCode <= 57")" />
                        <ValidationMessage For="@(() => newClienteDto.Identificacion)" />
                    </div>
                </div>
                <div class="mb-2">
                    <label class="form-label small fw-bold">Nombre Completo</label>
                    <InputText @bind-Value="newClienteDto.NombreCompleto" class="form-control" style="text-transform:uppercase;" />
                    <ValidationMessage For="@(() => newClienteDto.NombreCompleto)" />
                </div>
                <div class="mb-2">
                    <label class="form-label small fw-bold">Email</label>
                    <InputText @bind-Value="newClienteDto.Email" class="form-control" />
                    <ValidationMessage For="@(() => newClienteDto.Email)" />
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label class="form-label small fw-bold">Teléfono</label>
                        <InputText @bind-Value="newClienteDto.Telefono" class="form-control" maxlength="10" onkeypress="return event.charCode >= 48 && event.charCode <= 57" />
                    </div>
                    <div class="col-6">
                        <label class="form-label small fw-bold">País</label>
                        <InputText @bind-Value="newClienteDto.Pais" class="form-control" disabled="@(newClienteDto.TipoIdentificacion != TipoIdentificacion.Pasaporte)" />
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">Dirección</label>
                    <InputText @bind-Value="newClienteDto.Direccion" class="form-control" />
                </div>
                <div class="text-end">
                    <button type="button" class="btn btn-secondary me-2" @onclick="CloseClienteModal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" disabled="@isSubmittingNewClient">Guardar</button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    // --- LÓGICA IDENTICA A LA ANTERIOR (Sin cambios funcionales) ---
    // Variables de datos y estado
    private List<Cliente>? listaClientes;
    private List<Producto>? listaProductos;
    private string terminoBusquedaCliente = "";
    private bool mostrarListaClientes = false;
    private Cliente? clienteActual;

    // Filtros
    private IEnumerable<Cliente> clientesFiltrados => string.IsNullOrWhiteSpace(terminoBusquedaCliente) ? (listaClientes ?? Enumerable.Empty<Cliente>()).Take(5) : listaClientes?.Where(c => c.NombreCompleto.Contains(terminoBusquedaCliente, StringComparison.OrdinalIgnoreCase) || c.Identificacion.Contains(terminoBusquedaCliente)).Take(10) ?? Enumerable.Empty<Cliente>();
    private string terminoBusquedaProd = "";
    private IEnumerable<Producto> productosFiltrados => string.IsNullOrWhiteSpace(terminoBusquedaProd) ? (listaProductos ?? Enumerable.Empty<Producto>()).Where(p => p.Stock > 0).Take(12) : listaProductos?.Where(p => (p.Descripcion.Contains(terminoBusquedaProd, StringComparison.OrdinalIgnoreCase) || p.CodigoPrincipal.Contains(terminoBusquedaProd, StringComparison.OrdinalIgnoreCase)) && p.Stock > 0) ?? Enumerable.Empty<Producto>();

    // Carrito
    private List<ItemCarrito> carrito = new();
    private string? mensajeExito, mensajeError, facturaErrorMessage;
    private bool isSubmitting = false;

    // Modal
    private bool showClienteModal = false;
    private CreateCliente newClienteDto = new();
    private string? clienteValidationError;
    private bool isSubmittingNewClient = false;

    public class ItemCarrito
    {
        public int ProductoId { get; set; }
        public string ProductoNombre { get; set; } = "";
        public decimal PrecioUnitario { get; set; }
        public int Cantidad { get; set; }
        public decimal PorcentajeIVA { get; set; }
        public decimal Subtotal => PrecioUnitario * Cantidad;
    }

    protected override async Task OnInitializedAsync() => await LoadData();

    private async Task LoadData()
    {
        try
        {
            listaClientes = await Http.GetFromJsonAsync<List<Cliente>>("api/clientes");
            listaProductos = await Http.GetFromJsonAsync<List<Producto>>("api/productos?includeIva=true");
        }
        catch (Exception ex) { Console.WriteLine(ex.Message); }
    }

    // Buscador Cliente
    private void SeleccionarCliente(Cliente c) { clienteActual = c; terminoBusquedaCliente = ""; mostrarListaClientes = false; }
    private async Task OcultarListaClientes() { await Task.Delay(200); mostrarListaClientes = false; }
    private void LimpiarCliente() { clienteActual = null; terminoBusquedaCliente = ""; }

    // Carrito
    private void AgregarAlCarrito(Producto prod)
    {
        var item = carrito.FirstOrDefault(x => x.ProductoId == prod.Id);
        int qty = item?.Cantidad ?? 0;
        if (qty + 1 > prod.Stock) { facturaErrorMessage = $"Stock insuficiente de {prod.Descripcion}"; return; }

        if (item != null) item.Cantidad++;
        else carrito.Add(new ItemCarrito { ProductoId = prod.Id, ProductoNombre = prod.Descripcion, PrecioUnitario = prod.PrecioUnitario, PorcentajeIVA = prod.TarifaIva?.Porcentaje ?? 0, Cantidad = 1 });
        facturaErrorMessage = null;
    }
    private void AjustarCantidad(ItemCarrito item, int delta)
    {
        var prod = listaProductos?.FirstOrDefault(p => p.Id == item.ProductoId);
        if (prod == null) return;
        int nueva = item.Cantidad + delta;
        if (nueva > prod.Stock) { facturaErrorMessage = "Stock insuficiente"; return; }
        if (nueva <= 0) RemoverDelCarrito(item);
        else { item.Cantidad = nueva; facturaErrorMessage = null; }
    }
    private void RemoverDelCarrito(ItemCarrito item) => carrito.Remove(item);

    // Totales
    private decimal CalcularSubtotalIVA15() => carrito.Where(x => x.PorcentajeIVA > 0).Sum(x => x.Subtotal);
    private decimal CalcularSubtotalIVA0() => carrito.Where(x => x.PorcentajeIVA == 0).Sum(x => x.Subtotal);
    private decimal CalcularIVA() => carrito.Sum(x => x.Subtotal * (x.PorcentajeIVA / 100));

    // Facturar
    private async Task GenerarFactura()
    {
        if (clienteActual == null || !carrito.Any()) return;
        decimal total = carrito.Sum(x => x.Subtotal) + CalcularIVA();
        if (clienteActual.Identificacion == "9999999999999" && total > 50m) { facturaErrorMessage = $"Total ${total:F2} supera $50.00 para Consumidor Final."; return; }

        isSubmitting = true;
        try
        {
            var dto = new CreateFacturaDto { ClienteId = clienteActual.Id, Detalles = carrito.Select(i => new CreateDetalleFacturaDto { ProductoId = i.ProductoId, Cantidad = i.Cantidad }).ToList() };
            var res = await Http.PostAsJsonAsync("api/facturas", dto);
            if (res.IsSuccessStatusCode) { carrito.Clear(); LimpiarCliente(); mensajeExito = "Factura generada!"; await LoadData(); }
            else { var err = await res.Content.ReadAsStringAsync(); facturaErrorMessage = ExtraerMensajeError(err); }
        }
        catch { facturaErrorMessage = "Error de conexión"; }
        finally { isSubmitting = false; }
    }

    private string ExtraerMensajeError(string json) { try { if (!json.StartsWith("{")) return json.Trim('"'); using var d = System.Text.Json.JsonDocument.Parse(json); if (d.RootElement.TryGetProperty("message", out var m)) return m.GetString() ?? ""; return "Error datos"; } catch { return json; } }

    // Modal
    private void OpenClienteModal() { newClienteDto = new CreateCliente { TipoIdentificacion = TipoIdentificacion.Cedula, Pais = "Ecuador", Direccion = "S/D" }; showClienteModal = true; }
    private void CloseClienteModal() => showClienteModal = false;
    private void SetConsumidorFinal() { newClienteDto.TipoIdentificacion = TipoIdentificacion.Ruc; newClienteDto.Identificacion = "9999999999999"; newClienteDto.NombreCompleto = "CONSUMIDOR FINAL"; newClienteDto.Email = "cf@factura.com"; newClienteDto.Direccion = "S/D"; newClienteDto.Telefono = "9999999999"; newClienteDto.Pais = "Ecuador"; }
    private void OnTipoIdentificacionChange(ChangeEventArgs e) { if (Enum.TryParse<TipoIdentificacion>(e.Value?.ToString(), out var t)) { newClienteDto.TipoIdentificacion = t; if (t != TipoIdentificacion.Pasaporte) newClienteDto.Pais = "Ecuador"; else newClienteDto.Pais = ""; } }
    private int GetMaxLength(TipoIdentificacion t) => t == TipoIdentificacion.Cedula ? 10 : t == TipoIdentificacion.Ruc ? 13 : 20;
    private async Task HandleNewClientSubmit() { isSubmittingNewClient = true; try { var res = await Http.PostAsJsonAsync("api/clientes", newClienteDto); if (res.IsSuccessStatusCode) { await LoadData(); var nuevo = await res.Content.ReadFromJsonAsync<Cliente>(); if (nuevo != null) SeleccionarCliente(nuevo); CloseClienteModal(); } else { clienteValidationError = await res.Content.ReadAsStringAsync(); } } catch { clienteValidationError = "Error conexión"; } finally { isSubmittingNewClient = false; } }
}