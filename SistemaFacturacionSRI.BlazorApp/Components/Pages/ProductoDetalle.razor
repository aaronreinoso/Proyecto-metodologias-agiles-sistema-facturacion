@page "/productos/detalle/{Id:int}"
@using SistemaFacturacionSRI.Domain.Entities
@using SistemaFacturacionSRI.Domain.DTOs.LotesProducto
@using SistemaFacturacionSRI.Application.Interfaces
@inject IProductoService ProductoService
@inject ILoteProductoService LoteProductoService
@inject NavigationManager NavManager

<PageTitle>Detalle de Producto</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Detalle del Producto</h3>
        <button class="btn btn-secondary" @onclick="() => NavManager.NavigateTo("/productos")">
            ⬅️ Volver al Listado
        </button>
    </div>

    @if (isLoading)
    {
        <div class="text-center">Cargando...</div>
    }
    else if (producto == null)
    {
        <div class="alert alert-danger">Producto no encontrado.</div>
    }
    else
    {
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h4>@producto.Descripcion</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Código Principal:</strong> @producto.CodigoPrincipal</p>
                        <p><strong>Clasificación:</strong> @producto.TipoProducto (@(producto.EsPerecible ? "Perecible" : "No Perecible"))</p>
                        <p><strong>IVA Aplicado:</strong> @producto.TarifaIva?.Porcentaje.ToString("N0")%</p>
                        
                    </div>
                    <div class="col-md-6 text-end border-start">
                        <h5 class="mb-2">Stock Total Actual:</h5>
                        <h2 class="text-success fw-bold">@producto.Stock.ToString("N0") uds.</h2>
                        <button class="btn btn-sm btn-outline-warning mt-2">
                             Actualizar Precio Venta (PVP: @producto.PrecioUnitario.ToString("C2"))
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5>Lotes de Inventario</h5>
                <button class="btn btn-success" @onclick="() => isLoteModalVisible = true">
                    <i class="oi oi-plus"></i> Agregar Stock
                </button>
            </div>
            <div class="card-body">
                @if (lotes == null || !lotes.Any())
                {
                    <p class="text-muted text-center">No hay lotes registrados para este producto.</p>
                }
                else
                {
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Fecha Ingreso</th>
                                    <th>Cantidad Restante</th>
                                    <th>Costo Unitario</th>
                                    @if (producto.EsPerecible)
                                    {
                                        <th class="text-danger">Fecha Caducidad</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var lote in lotes)
                                {
                                    <tr>
                                        <td>@lote.FechaRegistro.ToLocalTime().ToString("yyyy-MM-dd")</td>
                                        <td>@lote.CantidadActual.ToString("N0")</td>
                                        <td>@lote.PrecioCompraUnitario.ToString("C5")</td> @* Alta precisión C5 *@
                                        @if (producto.EsPerecible)
                                        {
                                            <td class="@(lote.FechaCaducidad < DateTime.Now.AddMonths(1) ? "text-danger fw-bold" : "")">
                                                @(lote.FechaCaducidad?.ToString("yyyy-MM-dd") ?? "N/A")
                                            </td>
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    }
</div>

<LoteModal IsVisible="isLoteModalVisible" 
           OnClose="() => isLoteModalVisible = false"
           OnSave="HandleAddLote"
           EsPerecible="@(producto?.EsPerecible ?? false)" />

@code {
    [Parameter]
    public int Id { get; set; }

    private Producto? producto;
    private IEnumerable<LoteProducto>? lotes;
    private bool isLoading = true;
    private bool isLoteModalVisible = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadProductDetails();
    }
    
    private async Task LoadProductDetails()
    {
        isLoading = true;
        try
        {
            // Cargar producto completo (asumiendo que incluye TarifaIva)
            producto = await ProductoService.GetProductoByIdAsync(Id);
            if (producto != null)
            {
                await LoadLotes();
            }
        }
        catch (Exception)
        {
            // Manejo de error si el producto no existe o la API falla
            producto = null; 
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadLotes()
    {
        // El servicio de backend ya ordena por FEFO/FIFO, lo que facilita la visualización.
        lotes = await LoteProductoService.GetLotesByProductoIdAsync(Id);
    }
    
    private async Task HandleAddLote(CreateLoteProducto loteDto)
    {
        try
        {
            loteDto.ProductoId = Id;
            await LoteProductoService.AddLoteAsync(loteDto);
            
            // Actualizar la lista de lotes y los detalles del producto
            await LoadProductDetails(); 
            isLoteModalVisible = false;

            // Se asume una implementación de SnackBar o Toast para notificar el éxito
            // Snackbar.Add("Lote agregado y stock actualizado correctamente.", Severity.Success);
        }
        catch (InvalidOperationException ex)
        {
            // Manejar errores de negocio (ej. Producto no existe)
            // Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        catch (Exception)
        {
            // Snackbar.Add("Error inesperado al guardar el lote.", Severity.Error);
        }
    }
}